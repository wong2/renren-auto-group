// Generated by CoffeeScript 1.4.0
(function() {
  var $, AutoGroup;

  $ = window.jQuery;

  AutoGroup = {
    init: function() {
      this.NO_GROUP_NAME = '未分组好友';
      this.SHARED_FRIEND_URL_TMPL = _.template('http://friend.renren.com/shareFriends?p=\
                    {%22init%22:true,%22uid%22:true,%22uhead%22:false,%22uname%22:false,\
                    %22group%22:false,%22net%22:false,%22param%22:{%22guest%22:<%=uid%>}}');
      return this.createInitBtn();
    },
    createInitBtn: function() {
      var html,
        _this = this;
      html = '<div class="auto-group-btn-container">\
                     <a href="javascript:void(0)" class="auto-group-btn">自动分组</a>\
                 </div>';
      return this.btn = $(html).insertAfter('#groupList').click(function() {
        return _this.start();
      });
    },
    start: function() {
      var _this = this;
      this.friends = window.friends.map(function(friend) {
        return _.pick(friend, 'name', 'id', 'head', 'groups');
      });
      this.groups = $('#groupList li').map(function(index, element) {
        return element.title;
      });
      this.groups = _.without(this.groups, this.NO_GROUP_NAME);
      return this.loadSharedFriends(function() {
        console.log("all loaded");
        return _this.calculate();
      });
    },
    loadSharedFriends: function(callback) {
      var $queue, complete_count, friend_count, m_alert, _ref,
        _this = this;
      m_alert = XN.DO.alert({
        modal: true,
        title: '获取共同好友信息，请稍等',
        message: '加载中..'
      });
      m_alert.footer.hide();
      _ref = [0, this.friends.length], complete_count = _ref[0], friend_count = _ref[1];
      $queue = $({});
      this.friends.forEach(function(friend, index) {
        return $queue.queue('ajaxQueue', function(next) {
          var url;
          url = _this.SHARED_FRIEND_URL_TMPL({
            uid: friend.id
          });
          return $.getJSON(url, function(data) {
            complete_count += 1;
            m_alert.body.innerHTML = "进度：" + complete_count + "/" + friend_count;
            friend.sharedFriends = _.pluck(data.candidate, 'id');
            return next();
          });
        });
      });
      $queue.queue('ajaxQueue', function() {
        m_alert.hide();
        return callback.call(_this);
      });
      return $queue.dequeue('ajaxQueue');
    },
    calculate: function() {
      var m_alert;
      m_alert = XN.DO.alert({
        modal: true,
        title: '努力计算中，请稍等',
        message: '计算中...'
      });
      return m_alert.footer.hide();
    }
  };

  AutoGroup.init();

  window.AutoGroup = AutoGroup;

}).call(this);
